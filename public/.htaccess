# =========================
# WOI Endgame - Full .htaccess
# =========================

# Enable RewriteEngine
RewriteEngine On
RewriteBase /

# =========================
# HTTPS Redirect (use 307 to preserve POST body)
# =========================
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=307,L]

# =========================
# CORS is handled by PHP (bootstrap.php)
# Don't add CORS headers here
# =========================

# =========================
# Handle OPTIONS preflight for /api/ paths
# Let PHP handle the full response
# =========================
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^api(/|$) - [L]

RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^api-reference(/|$) - [L]

# =========================
# Never rewrite API paths - let PHP handle them
# =========================
RewriteRule ^api(/|$) - [L]
RewriteRule ^api-reference(/|$) - [L]

# =========================
# Serve real files and directories
# =========================
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# =========================
# SPA fallback (React Router)
# All other routes go to index.html
# =========================
RewriteRule ^ index.html [L]

# =========================
# Security: Block access to sensitive files
# =========================
<FilesMatch "(^\.htaccess|\.env|config\.php|db\.php|bootstrap\.php|env\.php)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# =========================
# Security: Disable directory listing
# =========================
Options -Indexes

# =========================
# Cache static assets
# =========================
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType font/woff2 "access plus 1 month"
</IfModule>

# =========================
# Compression
# =========================
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/css
    AddOutputFilterByType DEFLATE application/javascript application/json
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>
